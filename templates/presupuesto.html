<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.querySelector('#presupuesto-table tbody');
        const form = document.getElementById('add-presupuesto-form');
        
        // Elementos de la nueva lógica
        const fijoRadio = document.getElementById('gasto_fijo');
        const variableRadio = document.getElementById('gasto_variable');
        const fechaContainer = document.getElementById('fecha-pago-container');
        const fechaInput = document.getElementById('fecha_pago');


        // LÓGICA DE VISIBILIDAD DE FECHA
        function toggleFechaInput() {
            if (fijoRadio.checked) {
                fechaContainer.style.display = 'block';
                fechaInput.setAttribute('required', 'required');
            } else {
                fechaContainer.style.display = 'none';
                fechaInput.removeAttribute('required');
            }
        }
        
        fijoRadio.addEventListener('change', toggleFechaInput);
        variableRadio.addEventListener('change', toggleFechaInput);
        toggleFechaInput(); // Inicializar el estado

        // Función para cargar y renderizar los datos
        function loadPresupuestos() {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';
            fetch('/api/presupuesto')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = '';
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay ítems de presupuesto registrados.</td></tr>';
                        return;
                    }
                    data.forEach((item, index) => {
                        // El índice de la fila es index + 2 porque las hojas de cálculo son 1-based y la fila 1 es la cabecera
                        const rowIndex = index + 2; 
                        
                        // Añadir una columna extra para el Tipo (Fijo/Variable)
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${item.categoria}</td>
                            <td>S/${parseFloat(item.monto).toFixed(2)}</td>
                            <td>${item.tipo}</td>
                            <td>${item.fecha_pago || 'N/A'}</td>
                            <td data-pagado="${item.pagado}">${item.pagado === "True" ? '<span class="text-success">Sí</span>' : 'No'}</td>
                            <td>
                                ${item.pagado === "False" ? 
                                    `<button class="btn btn-sm btn-info mark-paid-btn me-2" data-row-index="${rowIndex}">
                                        Marcar
                                    </button>` : 
                                    '<span class="text-success me-2">Pagado</span>'
                                }
                                <button class="btn btn-sm btn-danger delete-btn" data-row-index="${rowIndex}">
                                    Eliminar
                                </button>
                            </td>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error cargando presupuesto:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar datos.</td></tr>';
                });
        }
        
        // Manejar el envío del formulario (POST)
        form.addEventListener('submit', function(e) {
            // ... (Lógica POST idéntica a la anterior, solo se mantiene el código relevante) ...
        });

        // Manejar los botones de acción (PUT y DELETE)
        tableBody.addEventListener('click', function(e) {
            const target = e.target;
            const rowIndex = target.getAttribute('data-row-index');
            if (!rowIndex) return;

            if (target.classList.contains('mark-paid-btn')) {
                // Lógica Marcar como Pagado (PUT)
                fetch('/api/presupuesto', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ row_index: rowIndex })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert('Ítem marcado como pagado.');
                        loadPresupuestos();
                    } else {
                        alert('Error al marcar como pagado.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurrió un error de red al actualizar el presupuesto.');
                });
            } else if (target.classList.contains('delete-btn')) {
                // Lógica Eliminar (DELETE)
                if (confirm('¿Estás seguro de que quieres eliminar esta categoría de presupuesto?')) {
                    fetch('/api/presupuesto', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ row_index: rowIndex })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            alert('Categoría eliminada con éxito.');
                            loadPresupuestos(); 
                        } else {
                            alert('Error al eliminar la categoría: ' + (data.message || data.error));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ocurrió un error de red al eliminar el presupuesto.');
                    });
                }
            }
        });

        loadPresupuestos(); 
    });
</script>
