/* --- En tu archivo JS o dentro de <script> en viajes.html --- */
document.addEventListener('DOMContentLoaded', function() {
    const tripForm = document.getElementById('trip-form');
    const tripsListDiv = document.getElementById('trips-list');
    const fechaInput = document.getElementById('fecha');
    
    // Funci칩n de utilidad para formatear n칰meros como moneda S/
    function formatCurrency(value) {
        // Asegura que es un n칰mero y lo formatea a 2 decimales
        return `S/${parseFloat(value).toFixed(2)}`;
    }

    // 1. Obtener y mostrar los viajes y el bono del d칤a (L칩gica GET)
    async function fetchAndDisplayTrips(date = fechaInput.value) {
        tripsListDiv.innerHTML = 'Cargando...';
        try {
            // Petici칩n GET a la API con la fecha actual o seleccionada
            const response = await fetch(`/api/trips?date=${date}`);
            const data = await response.json();
            
            if (response.status !== 200) {
                 tripsListDiv.innerHTML = `<div class="alert alert-danger">Error al cargar: ${data.error || 'API Error'}</div>`;
                return;
            }

            const trips = data.trips;
            // El bono total ya viene calculado desde Flask
            const bonus = parseFloat(data.bonus || 0); 
            
            let html = '';
            
            if (trips.length > 0) {
                // --- Construcci칩n de la Tabla de Viajes ---
                html += `
                    <p>Total de servicios hoy: <strong>${trips.length}</strong></p>
                    <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr><th>#</th><th>Inicio</th><th>Fin</th><th>Monto</th><th>Propina</th><th>Aerop.</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                `;
                let totalMonto = 0;
                let totalPropina = 0;
                let totalDiaViajes = 0; // Total de solo viajes (Monto + Propina + Aerop.)

                trips.forEach(trip => {
                    // gspread lee como float si los datos tienen decimales
                    const monto = parseFloat(trip.Monto);
                    const propina = parseFloat(trip.Propina);
                    const rowTotal = parseFloat(trip.Total);
                    
                    totalMonto += monto;
                    totalPropina += propina;
                    totalDiaViajes += rowTotal;
                    
                    html += `
                        <tr>
                            <td>${trip.Numero}</td>
                            <td>${trip['Hora inicio']}</td>
                            <td>${trip['Hora fin']}</td>
                            <td>${formatCurrency(monto)}</td>
                            <td>${formatCurrency(propina)}</td>
                            <td>${trip.Aeropuerto > 0 ? 'S칤' : 'No'}</td>
                            <td><strong>${formatCurrency(rowTotal)}</strong></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;

                // --- Mostrar Resumen y Bonos ---
                const totalFinalDia = totalDiaViajes + bonus;

                html += `
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h4>Resumen de Ingresos por Viajes</h4>
                            <p>Monto base (viajes): <strong>${formatCurrency(totalMonto)}</strong></p>
                            <p>Propina total: <strong>${formatCurrency(totalPropina)}</strong></p>
                            <p>Subtotal (Monto + Propina): <strong>${formatCurrency(totalDiaViajes)}</strong></p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <h4>游눯 Bonificaci칩n de Uber</h4>
                            <p class="text-success">Bono por ${trips.length} servicios: <strong>${formatCurrency(bonus)}</strong></p>
                            <hr class="d-md-none">
                            <p class="h4">Total de Ingresos del D칤a</p>
                            <p class="h2 text-primary"><strong>${formatCurrency(totalFinalDia)}</strong></p>
                        </div>
                    </div>
                `;

            } else {
                html = '<div class="alert alert-info">A칰n no hay viajes registrados para este d칤a.</div>';
            }
            
            tripsListDiv.innerHTML = html;

        } catch (error) {
            console.error('Error al cargar los viajes:', error);
            tripsListDiv.innerHTML = '<div class="alert alert-danger">Error al conectar con la API de viajes.</div>';
        }
    }

    // 2. Manejar el env칤o del formulario (L칩gica POST)
    tripForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
            fecha: tripForm.fecha.value,
            hora_inicio: tripForm.hora_inicio.value,
            hora_fin: tripForm.hora_fin.value,
            monto: parseFloat(tripForm.monto.value),
            propina: parseFloat(tripForm.propina.value || 0),
            aeropuerto: tripForm.aeropuerto.checked
        };
        
        try {
            const response = await fetch('/api/trips', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (response.ok) {
                // Mensaje de 칠xito y bono actualizado
                alert(`Viaje #${result.trip.Numero} registrado. Bono total actualizado a ${formatCurrency(result.new_bonus)}.`);
                
                // Limpiar inputs del formulario
                tripForm.hora_inicio.value = '';
                tripForm.hora_fin.value = '';
                tripForm.monto.value = '';
                tripForm.propina.value = '0';
                tripForm.aeropuerto.checked = false;
                
                // Recargar la lista para mostrar el nuevo viaje y el bono
                fetchAndDisplayTrips(data.fecha);
            } else {
                 alert(`Error al registrar el viaje: ${result.error || response.statusText}`);
            }
            
        } catch (error) {
            console.error('Error de red:', error);
            alert('Error al conectar con el servidor.');
        }
    });
    
    // 3. Inicializaci칩n: Cargar viajes al iniciar y al cambiar la fecha
    fetchAndDisplayTrips();
    fechaInput.addEventListener('change', () => fetchAndDisplayTrips());
});
